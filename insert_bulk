#!/usr/bin/pythonimport subprocessimport osimport csvimport loggingimport timeimport getoptimport sysimport csvfrom xlrd import open_workbookimport shutilimport MySQLdbmysql_server1='10.137.2.57'mysql_database1='cmdb'mysqluser1='idcadm'mysqluserpass1='redhat'mysql_server='10.137.2.100'mysql_database='cmdb'mysqluser='idcadm'mysqluserpass='Idcadm@789'db = MySQLdb.connect(mysql_server,mysqluser,mysqluserpass,mysql_database)cursor = db.cursor()db1 = MySQLdb.connect(mysql_server1,mysqluser1,mysqluserpass1,mysql_database1)cursor1 = db1.cursor()shutil.copy(sys.argv[1], '/storage/repo/app/bulkupdate/updated_file/')#print 'Number of arguments:', len(sys.argv), 'arguments.'#print 'Argument List:', str(sys.argv)sizeofagrv=len(sys.argv)firstline=Trueheading=""file_location="http://www.idc.rjil.ril.com/bulkupdate/insert_file/"+sys.argv[3]file_name=sys.argv[3]updated_by=sys.argv[2]query="insert into t_user_fileupload (FILE_NAME,FILE_LOCATION,FILE_UPDATED_BY) values ('"+file_name+"','"+file_location+"','"+updated_by+"')"#print querycursor.execute(query)m_arr=[]csv_data = csv.reader(file(sys.argv[1]))for row in csv_data :   if firstline:      print "firstline",row      heading=row      firstline=False      del heading[0]      #head1=heading[0]      #print head1   else:      print row      arr=[]      table_name=row[0]      head1=heading[0]      del row[0]      print table_name      print head1      str2=""      sql_dump="mysqldump -u "+mysqluser+" -h"+mysql_server+" -p"+mysqluserpass+" "+mysql_database+" "+table_name+" | gzip > /opt/rjil/bulk_update/backup/"+table_name+"'_'"+time.strftime("%Y-%m-%d_%H:%M:%S")+".sql.gz"      cmd_out= subprocess.Popen(sql_dump, shell = True, stdout=subprocess.PIPE)      out,err =cmd_out.communicate()      #print sql_dump      #print "sql dump output", out      str1 = ','.join(str(e) for e in heading)      for x in row:        str2+=','+"'"+str(x)+"'"      str2=str2.lstrip(',')      print table_name      res1=""      #print len(str2)      #print len(str1)      status=""      try:           per_query="select insert_"+table_name+" from login where username='"+updated_by+"'"           #print per_query           cursor1.execute(per_query)           res1=cursor1.fetchone()           if res1[0] == "Y":              try:                 ins_query="insert into "+table_name+" ("+str1+") values ("+str2+")"                 #print ins_query                 cursor.execute(ins_query)                 db.commit()                 status="Values inserted into table:"              except db.Error, e:                 if db:                   db.rollback()                 status="Failed to insert into table "+table_name+" and Error %d: %s" % (e.args[0],e.args[1])           else:              status="User does not have acces insert into the table"+table_name      except db1.Error, e:           if db1:             db1.rollback()           #print row           status="Unable get the permission details for  "+table_name+" and Error %d: %s" % (e.args[0],e.args[1])           print status      #print per_query      #print res1[0]      #print type(res1[0])      """      if res1[0] == "Y":        try:           ins_query="insert into "+table_name+" ("+str1+") values ("+str2+")"           cursor.execute(ins_query)           db.commit()           status="Values inserted into table:"        except db.Error, e:           if db:             db.rollback()           status="Failed to insert into table "+table_name+" and Error %d: %s" % (e.args[0],e.args[1])      else:         status="User does not have acces insert into the table"+table_name      """      arr.append(table_name)      arr.append(status)      for r1 in row:         arr.append(r1)      m_arr.append(arr)      #cursor.execute(ins_query)      #db.commit()head=['TABLE NAME','STATUS']for r2 in heading:   head.append(r2)#print m_arr#      for i in row:#         None#print "value:",i,"\n"#print headingcr_html=open("bulk_insert.html","w")#cr_html.write("<html>"+"\n")cr_html.write('<h3 style="color:blue">Status of bulk insert</h3>')#cr_html.write('<a href="http://10.137.2.57/bulkupdate/'+fs+'" style="color:red" >Click here to check log </a>')cr_html.write('<table border="1">'+'\n')cr_html.write("<tr>"+"\n")for xx in head:    cr_html.write("<td>"+xx+"</td>")cr_html.write("</tr>")cr_html.write("<tr>"+"\n")for i in m_arr:   cr_html.write("<tr>"+"\n")   for x in i:      cr_html.write("<td>"+x+"</td>")   cr_html.write("</tr>")cr_html.write("</table>"+"\n")    #cr_html.write("</html>"+"\n")cr_html.close()
